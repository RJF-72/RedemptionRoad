<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SOTA Audio Authenticity Checker</title>
  <style>
    body { background: #0a0f1a; color: #e6f1ff; font-family: JetBrains Mono, monospace; margin: 0; }
    .container { max-width: 900px; margin: 40px auto; padding: 24px; }
    h1 { color: #64ffda; text-shadow: 0 0 12px rgba(100,255,218,.5); }
    .card { background:#0f1726; border:1px solid #1f2a44; border-radius:12px; padding:20px; box-shadow:0 0 20px rgba(100,255,218,.08) inset; }
    .row { display:flex; gap:16px; flex-wrap:wrap; margin:12px 0; }
    .btn { background:#64ffda; color:#001219; padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:700; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    input[type="file"] { background:#0a1324; border:1px dashed #24324d; color:#bcd; padding:10px; border-radius:8px; }
    .result { background:#06101f; border:1px solid #173; padding:12px; border-radius:8px; margin-top:16px; }
    a { color:#64ffda; }
    nav { background:#070b14; border-bottom:1px solid #16233a; padding:12px 0; }
    nav .inner { max-width: 1000px; margin: 0 auto; display:flex; align-items:center; gap:16px; }
  </style>
</head>
<body>
  <nav>
    <div class="inner">
      <a href="./index.html">Home</a>
      <a href="./SOTA_Music_Video_Generator.html">Music Video</a>
      <a href="./SOTA_Marketing_Video_Creator.html">Marketing Video</a>
      <a href="./SOTA_Script_To_Video_Engine.html">Script→Video</a>
      <a href="./synthesizer.html">Synth</a>
      <a href="./daw.html">DAW</a>
      <a href="./voice.html">Voice</a>
      <a href="./HOW_TO_USE.md" target="_blank" rel="noopener">Docs</a>
    </div>
  </nav>
  <div class="container">
    <h1>Audio Authenticity Checker</h1>
    <p>Upload a reference WAV (human performance) and a candidate WAV (intelligent instrument output). We’ll compute an authenticity percentage (0–100) using MFCC + DTW similarity and spectral centroid correlation. CPU-only friendly.</p>
    <div class="card">
      <div class="row">
        <div>
          <label>Reference WAV:</label><br />
          <input id="ref" type="file" accept="audio/*" />
        </div>
        <div>
          <label>Candidate WAV:</label><br />
          <input id="cand" type="file" accept="audio/*" />
        </div>
      </div>
      <button id="run" class="btn">Compare</button>
      <div style="margin-top:8px;">
        <label>Profile:</label>
        <select id="profile">
          <option value="melodic" selected>Melodic (guitar, piano)</option>
          <option value="percussive">Percussive (drums)</option>
          <option value="general">General</option>
        </select>
      </div>
      <div id="out" class="result" style="display:none;"></div>
    </div>
  </div>
  <script src="./config.js"></script>
  <script src="./voice.js"></script>
  <script>
    const btn = document.getElementById('run');
    const out = document.getElementById('out');

    // Backend health check banner
    (async function(){
      const base = (window.SOTA_BACKEND_URL || '');
      if (!base) return; // same-origin proxy
      try{
        const r = await fetch(base + '/api/health', {cache:'no-store'});
        if(!r.ok) throw new Error('bad');
        const j = await r.json();
        if(j && j.status === 'ok') return; // healthy
      }catch(e){
        const nav = document.querySelector('nav .inner');
        const warn = document.createElement('div');
        warn.style.marginLeft = 'auto';
        warn.style.color = '#f59e0b';
        warn.style.fontSize = '12px';
        warn.textContent = 'Backend offline — using local estimator';
        nav && nav.appendChild(warn);
      }
    })();

    // Tiny client-side fallback estimator (RMS + naive spectral centroid)
    async function estimateLocalAuthenticity(fileA, fileB){
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const [abA, abB] = await Promise.all([fileA.arrayBuffer(), fileB.arrayBuffer()]);
      const [bufA, bufB] = await Promise.all([
        ctx.decodeAudioData(abA.slice(0)),
        ctx.decodeAudioData(abB.slice(0))
      ]);
      function feats(buf){
        const x = buf.getChannelData(0);
        const n = x.length;
        const L = Math.min(n, buf.sampleRate * 5); // analyze up to 5s
        const s = x.subarray(0, L);
        const rms = Math.sqrt(s.reduce((acc,v)=>acc+v*v,0)/Math.max(1,s.length));
        // crude centroid proxy via zero-crossings density
        let zc=0; for(let i=1;i<s.length;i++){ const a=s[i-1], b=s[i]; if((a>=0&&b<0)||(a<0&&b>=0)) zc++; }
        const centroid = zc/Math.max(1,s.length);
        return {rms, centroid};
      }
      const fa = feats(bufA), fb = feats(bufB);
      const rmsSim = 1 - Math.min(1, Math.abs(fa.rms - fb.rms) / (fa.rms + fb.rms + 1e-6));
      const cenSim = 1 - Math.min(1, Math.abs(fa.centroid - fb.centroid) / (fa.centroid + fb.centroid + 1e-6));
      const sim = 0.6*rmsSim + 0.4*cenSim;
      return {
        authenticity_percent: Math.round(sim*10000)/100,
        similarity: { rms_similarity: Math.round(rmsSim*1000)/1000, centroid_similarity: Math.round(cenSim*1000)/1000 },
        dtw_raw: null,
        profile: 'local-estimate'
      };
    }
    btn.addEventListener('click', async () => {
      const ref = document.getElementById('ref').files[0];
      const cand = document.getElementById('cand').files[0];
      if(!ref || !cand){ alert('Please select both WAV files.'); return; }
      btn.disabled = true; out.style.display = 'block'; out.textContent = 'Computing...';
      try{
        const fd = new FormData();
        fd.append('reference', ref);
        fd.append('candidate', cand);
        fd.append('profile', document.getElementById('profile').value);
        const base = (window.SOTA_BACKEND_URL || '');
        let usedFallback = false;
        let data;
        try{
          const resp = await fetch(base + '/api/audio/authenticity', { method:'POST', body: fd });
          if(!resp.ok) throw new Error('bad');
          data = await resp.json();
        }catch(e){
          usedFallback = true;
          data = await estimateLocalAuthenticity(ref, cand);
        }
        out.innerHTML = `
          <strong>Authenticity:</strong> ${data.authenticity_percent}% ${usedFallback?'<span style="color:#f59e0b">(local estimate)</span>':''}<br/>
          ${data.similarity?.dtw_based!==undefined?`<strong>Similarity (DTW-based):</strong> ${data.similarity.dtw_based}<br/>`:''}
          ${data.similarity?.centroid_corr!==undefined?`<strong>Similarity (Centroid Corr):</strong> ${data.similarity.centroid_corr}<br/>`:''}
          ${data.similarity?.rms_similarity!==undefined?`<strong>RMS similarity:</strong> ${data.similarity.rms_similarity}<br/>`:''}
          ${data.similarity?.centroid_similarity!==undefined?`<strong>Centroid similarity:</strong> ${data.similarity.centroid_similarity}<br/>`:''}
          ${data.dtw_raw!==null?`<em>DTW raw:</em> ${data.dtw_raw}`:''}
        `;
      }catch(e){
        out.textContent = 'Error: ' + e.message;
      }finally{
        btn.disabled = false;
      }
    });
  </script>
  <script>
    // Voice commands for Audio Authenticity
    (function(){
      if (!window.SOTAVoice) return;
      SOTAVoice.init({ tts: false });
      const setProfile = (name) => { const sel=document.getElementById('profile'); if(!sel) return; const opt=Array.from(sel.options).find(o=>o.value.toLowerCase()===name); if(opt){ sel.value=opt.value; sel.dispatchEvent(new Event('change')); } };
      SOTAVoice.registerCommands([
        { pattern: /^(?:upload|select) reference$/i, description: 'Choose reference WAV', handler: ()=>{ const inp=document.getElementById('ref'); if(inp) inp.click(); } },
        { pattern: /^(?:upload|select) (?:candidate|compare)$/i, description: 'Choose candidate WAV', handler: ()=>{ const inp=document.getElementById('cand'); if(inp) inp.click(); } },
        { pattern: /^set profile (melodic|percussive|general)$/i, description: 'Set analysis profile', handler: (m)=> setProfile(m[1]) },
        { pattern: /^(?:run|start|compare)$/i, description: 'Run authenticity comparison', handler: ()=>{ const b=document.getElementById('run'); b && b.click(); } },
      ]);
    })();
  </script>
  <script src="./composer-shim.js"></script>
</body>
</html>
